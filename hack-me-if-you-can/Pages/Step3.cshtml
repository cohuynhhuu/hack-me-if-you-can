@page
@model Step3Model
@{
    ViewData["Title"] = "STEP 3: CSRF Protection";
}

<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2><i class="bi bi-3-circle-fill text-info"></i> STEP 3: CSRF Protection</h2>
                <a href="/" class="btn btn-outline-secondary"><i class="bi bi-house"></i> Dashboard</a>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="demo-section vulnerable-section">
                <h4 class="text-danger"><i class="bi bi-exclamation-triangle-fill"></i> Vulnerable</h4>
                <p><strong>Problem:</strong> No anti-forgery token validation</p>
                
                <!-- Quick Demo Buttons for CSRF Attacks -->
                <div class="mb-3">
                    <h6><i class="bi bi-lightning-fill"></i> Quick CSRF Attack Demos:</h6>
                    <div class="btn-group-vertical d-grid gap-1">
                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="quickCSRFFormAttack()">
                            <i class="bi bi-bug"></i> Quick Demo: Form CSRF Attack
                        </button>
                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="quickCSRFImageAttack()">
                            <i class="bi bi-image"></i> Quick Demo: Image Tag CSRF
                        </button>
                    </div>
                </div>

                <!-- Educational Content -->
                <div class="alert alert-warning">
                    <h6><i class="bi bi-info-circle"></i> How CSRF Attacks Work:</h6>
                    <ul class="mb-0 small">
                        <li><strong>Cross-Site Request Forgery:</strong> Attacker tricks user's browser into making unauthorized requests</li>
                        <li><strong>Attack Vector:</strong> Malicious email/website sends requests using user's authenticated session</li>
                        <li><strong>No Token Check:</strong> Server can't distinguish legitimate vs malicious requests</li>
                    </ul>
                </div>
                
                <form onsubmit="testCSRFVulnerable(event)">
                    <div class="mb-3">
                        <label class="form-label">Email Update (No Token Protection):</label>
                        <input type="email" id="vulnEmail" class="form-control" placeholder="new-email@example.com" required>
                    </div>
                    <button type="submit" class="btn btn-vulnerable w-100">
                        <i class="bi bi-bug-fill"></i> Submit (No Token Protection)
                    </button>
                </form>
                <div id="vulnCSRFResult" class="result-panel"></div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="demo-section secure-section">
                <h4 class="text-success"><i class="bi bi-shield-check-fill"></i> Secure</h4>
                <p><strong>Solution:</strong> Anti-forgery tokens (ValidateAntiForgeryToken)</p>
                
                <!-- Quick Demo Buttons for Protected Actions -->
                <div class="mb-3">
                    <h6><i class="bi bi-shield-check"></i> Quick Protection Demos:</h6>
                    <div class="btn-group-vertical d-grid gap-1">
                        <button type="button" class="btn btn-outline-success btn-sm" onclick="quickCSRFSecureSubmit()">
                            <i class="bi bi-check-circle"></i> Try Same Attack - Watch It Get Blocked!
                        </button>
                        <button type="button" class="btn btn-outline-success btn-sm" onclick="quickCSRFLegitimateRequest()">
                            <i class="bi bi-person-check"></i> Legitimate User Request (Protected)
                        </button>
                    </div>
                </div>

                <!-- Educational Content for Protection -->
                <div class="alert alert-success">
                    <h6><i class="bi bi-shield-fill"></i> How CSRF Protection Works:</h6>
                    <ul class="mb-0 small">
                        <li><strong>Anti-Forgery Tokens:</strong> Server generates unique token for each user session</li>
                        <li><strong>Token Validation:</strong> Server checks token matches on every state-changing request</li>
                        <li><strong>SameSite Cookies:</strong> Browser restrictions prevent cross-site cookie transmission</li>
                        <li><strong>Origin/Referer Headers:</strong> Server validates request source is legitimate</li>
                    </ul>
                </div>

                <form onsubmit="testCSRFSecure(event)">
                    <!-- Anti-forgery token (normally generated by @Html.AntiForgeryToken()) -->
                    <input type="hidden" name="__RequestVerificationToken" value="DEMO_TOKEN_ABC123">
                    <div class="mb-3">
                        <label class="form-label">Email Update (Token Protected):</label>
                        <input type="email" id="secureEmail" class="form-control" placeholder="secure-email@example.com" required>
                        <div class="form-text">
                            üîí Protected by anti-forgery token: <code>__RequestVerificationToken</code>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-secure w-100">
                        <i class="bi bi-shield-fill"></i> Submit (Token Protected)
                    </button>
                </form>
                <div id="secureCSRFResult" class="result-panel"></div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-12">
            <div class="highlight-box highlight-info">
                <h5><i class="bi bi-info-circle-fill"></i> CSRF Defenses</h5>
                <ul class="mb-0">
                    <li>[ValidateAntiForgeryToken] attribute on controller actions</li>
                    <li>@Html.AntiForgeryToken() in forms</li>
                    <li>SameSite cookie attribute</li>
                    <li>Custom request headers for AJAX</li>
                </ul>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    function testCSRFVulnerable(e) {
        e.preventDefault();
        const email = document.getElementById('vulnEmail').value;
        
        showResult('vulnCSRFResult', 'error', 'üö® CSRF VULNERABLE: Request accepted without validation!', {
            userInput: email,
            vulnerability: "No anti-forgery token validation",
            attackScenario: "Malicious website could automatically submit requests as this user",
            whatHappened: [
                "üìß Email update request processed without verification",
                "üîì No check for request authenticity", 
                "üîì Attacker could change user's email via CSRF",
                "üîì Session hijacking possible through email change",
                "üîì Account takeover risk"
            ],
            exampleAttack: {
                method: "Hidden iframe or image tag on malicious site",
                payload: `<img src="/update-email?email=attacker@evil.com" style="display:none">`,
                impact: "User's email changed without their knowledge"
            },
            riskLevel: "HIGH - State-changing operation without protection",
            warning: "‚ö†Ô∏è In production, this could lead to complete account compromise!"
        });
    }

    function testCSRFSecure(e) {
        e.preventDefault();
        const email = document.getElementById('secureEmail').value;
        const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
        
        showResult('secureCSRFResult', 'success', '‚úÖ CSRF PROTECTED: Token validation successful!', {
            userInput: email,
            tokenUsed: token,
            protection: "Anti-forgery token validation + SameSite cookies",
            validationProcess: [
                "üîç Server validates __RequestVerificationToken",
                "üîç Checks token matches user's session",
                "üîç Verifies request Origin/Referer headers", 
                "üîç Confirms SameSite cookie restrictions",
                "‚úÖ All validations passed - request accepted"
            ],
            tokenDetails: {
                purpose: "Cryptographic proof of request legitimacy",
                generation: "Unique per user session, includes anti-forgery data",
                validation: "Server-side verification against session data"
            },
            protectionLayers: [
                "‚úÖ [ValidateAntiForgeryToken] attribute on controller",
                "‚úÖ @Html.AntiForgeryToken() in form", 
                "‚úÖ SameSite=Strict cookie policy",
                "‚úÖ Origin header validation",
                "‚úÖ Secure token generation"
            ],
            result: "CSRF attack vectors successfully blocked"
        });
    }

    // Quick demo functions
    function quickCSRFFormAttack() {
        document.getElementById('vulnEmail').value = 'attacker@evil.com';
        showResult('vulnCSRFResult', 'warning', 'üìù CSRF Attack Payload Set', {
            attackVector: "Form-based CSRF",
            payload: "Email change to attacker-controlled address",
            explanation: "Malicious site could submit this form automatically when user visits",
            htmlExample: `<form action="victim-site.com/update-email" method="post">
  <input type="hidden" name="email" value="attacker@evil.com">
  <input type="submit" value="Click Here for Free Gift!">
</form>`,
            note: "Click 'Submit (No Token Protection)' to see the vulnerability in action"
        });
    }

    function quickCSRFImageAttack() {
        document.getElementById('vulnEmail').value = 'csrf.attack@malicious.site';
        showResult('vulnCSRFResult', 'warning', 'üìù Image-based CSRF Payload Set', {
            attackVector: "Image tag CSRF (GET request)",
            payload: "Hidden image that triggers state change",
            explanation: "Image loads automatically, triggering the attack without user interaction",
            htmlExample: `<img src="victim-site.com/update-email?email=csrf.attack@malicious.site" 
     style="display:none" width="1" height="1">`,
            stealth: "User never sees the image - attack is completely hidden",
            note: "Click 'Submit (No Token Protection)' to see how easily this succeeds"
        });
    }

    function quickCSRFSecureSubmit() {
        document.getElementById('secureEmail').value = 'attacker@evil.com';
        showResult('secureCSRFResult', 'info', 'üõ°Ô∏è Testing CSRF Protection with Attack Payload', {
            testScenario: "Using same malicious email as vulnerable side",
            expectation: "Request should be validated and accepted (due to valid token)",
            difference: "Token validation occurs server-side - protection is transparent to user",
            note: "Click 'Submit (Token Protected)' to see how protection works"
        });
    }

    function quickCSRFLegitimateRequest() {
        document.getElementById('secureEmail').value = 'user.update@mycompany.com';
        showResult('secureCSRFResult', 'info', 'üë§ Legitimate User Request Example', {
            scenario: "Normal user updating their email address",
            protection: "Same anti-forgery validation applies to all requests",
            transparency: "User experience unchanged - security happens behind scenes",
            note: "Click 'Submit (Token Protected)' to see normal operation"
        });
    }
</script>
}
